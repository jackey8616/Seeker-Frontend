import{d as G,u as J,a as K,r as d,o as Q,b as W,c as B,e as a,w as t,f as i,g as n,t as c,h as u,i as z,j as N,k as X,l as y}from"./index-D69y5L_k.js";const Y={class:"mail"},Z={class:"d-flex gap-2"},ee=["src"],te={class:"d-flex align-center justify-space-between pa-4"},ae={class:"d-flex align-center gap-2"},le={class:"text-caption"},oe={class:"text-caption"},ne={class:"d-flex align-center gap-1"},se={class:"mb-4"},ie={class:"mb-4"},re={key:0,class:"mail-content"},de=["src"],ve=G({__name:"MailListView",setup(ce){const E=J(),{axios:L}=K(),R=[{title:"Action",key:"action",sortable:!1},{title:"Sender",key:"sender",sortable:!1},{title:"Title",key:"title",sortable:!1},{title:"Date",key:"date",sortable:!1}],M=d([]),C=d(null),h=d(0),v=d(1),D=d(!1),_=d(null),V=d(10),k=d(!1),g=d(null);async function q(s){var e;try{return(await L.value.get(`/mails/${s}`,{signal:(e=_.value)==null?void 0:e.signal})).data.data.mail}catch(o){if(o.name==="AbortError")return console.log("Request was aborted"),null;throw o}}function T(s){const e=new Blob([s],{type:"text/html"});return URL.createObjectURL(e)}async function U(s=1){var e,o;D.value=!0;try{const m=s===1?{}:{next_page_token:C.value},b=await L.value.post("/mails/list",m,{signal:(e=_.value)==null?void 0:e.signal}),{data:x}=b.data;if(M.value=x.mail_infos,C.value=x.next_page_token,h.value=x.total_count,v.value=s,!((o=_.value)!=null&&o.signal.aborted)){const A=M.value.map(f=>q(f.id).then(r=>{var w;r&&!((w=_.value)!=null&&w.signal.aborted)&&(f.sender=r.sender,f.title=r.title,f.date=r.date,f.detailMail=r)}).catch(r=>{r.name!=="AbortError"&&console.error(`Download mail id ${f.id} cause error`,r)}));await Promise.all(A)}}catch(m){if(m.name==="AbortError"){console.log("List request was aborted");return}console.error("Error fetching mail list:",m)}finally{D.value=!1}}function P(s){U(s)}function F(s){g.value=s,k.value=!0}function S(){k.value=!1,g.value=null}return Q(()=>{_.value=new AbortController,U()}),W(()=>{_.value&&(_.value.abort(),_.value=null)}),(s,e)=>{const o=i("v-icon"),m=i("v-tooltip"),b=i("v-btn"),x=i("router-link"),A=i("v-chip"),f=i("v-divider"),r=i("v-data-table-server"),w=i("v-card-title"),H=i("v-card-text"),I=i("v-card"),O=i("v-dialog");return y(),B("div",Y,[a(r,{headers:R,items:M.value,loading:D.value,"items-length":h.value,page:v.value,"items-per-page":V.value,"onUpdate:page":P,"hide-default-footer":"",hover:""},{"item.action":t(({item:l})=>[n("div",Z,[a(b,{icon:"",size:"x-small",onClick:p=>F(l)},{default:t(()=>[a(o,{icon:"mdi-email-open"}),a(m,{activator:"parent",location:"bottom"},{default:t(()=>e[3]||(e[3]=[u("View Mail")])),_:1})]),_:2},1032,["onClick"]),l.detailMail!==void 0?(y(),X(x,{key:0,to:{name:"mail-fitting",params:{thread_id:l.detailMail.id}},custom:""},{default:t(({navigate:p})=>[a(b,{icon:"",size:"x-small",onClick:p},{default:t(()=>[a(o,{icon:"mdi-brain"}),a(m,{activator:"parent",location:"bottom"},{default:t(()=>e[4]||(e[4]=[u("Fitting By AI")])),_:1})]),_:2},1032,["onClick"])]),_:2},1032,["to"])):z("",!0)])]),"item.date":t(({item:l})=>[a(A,{size:"x-small"},{default:t(()=>[u(c(N(E).format(l.date,"keyboardDateTime24h"))+" ",1),a(m,{activator:"parent",location:"bottom"},{default:t(()=>[u(c(l.date),1)]),_:2},1024)]),_:2},1024)]),"expanded-row":t(({item:l})=>{var p;return[(p=l.detailMail)!=null&&p.extracted_data?(y(),B("iframe",{key:0,src:T(l.detailMail.extracted_data),width:"100%"},null,8,ee)):z("",!0)]}),bottom:t(()=>[n("div",te,[n("div",ae,[n("div",le,c((v.value-1)*V.value+1)+"-"+c(Math.min(v.value*V.value,h.value))+" of "+c(h.value),1),a(f,{vertical:"",class:"mx-2"}),n("div",oe," Page "+c(v.value),1)]),n("div",ne,[a(b,{icon:"",size:"small",variant:"text",disabled:v.value===1,onClick:e[0]||(e[0]=l=>P(v.value-1))},{default:t(()=>[a(o,null,{default:t(()=>e[5]||(e[5]=[u("mdi-chevron-left")])),_:1})]),_:1},8,["disabled"]),a(b,{icon:"",size:"small",variant:"text",disabled:!C.value,onClick:e[1]||(e[1]=l=>P(v.value+1))},{default:t(()=>[a(o,null,{default:t(()=>e[6]||(e[6]=[u("mdi-chevron-right")])),_:1})]),_:1},8,["disabled"])])])]),_:1},8,["items","loading","items-length","page","items-per-page"]),a(O,{modelValue:k.value,"onUpdate:modelValue":e[2]||(e[2]=l=>k.value=l),"max-width":"800px",persistent:""},{default:t(()=>[a(I,null,{default:t(()=>[a(w,{class:"d-flex justify-space-between align-center"},{default:t(()=>{var l;return[n("span",null,c((l=g.value)==null?void 0:l.title),1),a(b,{icon:"",onClick:S},{default:t(()=>[a(o,null,{default:t(()=>e[7]||(e[7]=[u("mdi-close")])),_:1})]),_:1})]}),_:1}),a(H,null,{default:t(()=>{var l,p,$,j;return[n("div",se,[e[8]||(e[8]=n("strong",null,"From:",-1)),u(" "+c((l=g.value)==null?void 0:l.sender),1)]),n("div",ie,[e[9]||(e[9]=n("strong",null,"Date:",-1)),u(" "+c(N(E).format((p=g.value)==null?void 0:p.date,"keyboardDateTime24h")),1)]),(j=($=g.value)==null?void 0:$.detailMail)!=null&&j.extracted_data?(y(),B("div",re,[n("iframe",{src:T(g.value.detailMail.extracted_data),width:"100%",height:"500px",frameborder:"0"},null,8,de)])):z("",!0)]}),_:1})]),_:1})]),_:1},8,["modelValue"])])}}});export{ve as default};
